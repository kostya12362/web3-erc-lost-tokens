<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>React CDN</title>
  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>

  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-router/6.14.2/react-router.development.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-router-dom@6.14.2/dist/umd/react-router-dom.production.min.js" crossorigin></script>

  <script src='https://unpkg.com/babel-standalone@6.26.0/babel.js'></script>
  <script src="https://unpkg.com/react-bootstrap@next/dist/react-bootstrap.min.js" crossorigin></script>



  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />


</head>

<body>
  <div id="root"></div>
  <script src="./index.js" type="text/babel"></script>
  <script type="text/babel" data-presets="react,stage-3">
    const { useState, useEffect } = React;
    const ERC20 = [
      {
        constant: true,
        inputs: [],
        name: "name",
        outputs: [{ name: "", type: "string" }],
        payable: false,
        stateMutability: "view",
        type: "function",
      },
      {
        constant: false,
        inputs: [
          { name: "_spender", type: "address" },
          { name: "_value", type: "uint256" },
        ],
        name: "approve",
        outputs: [{ name: "", type: "bool" }],
        payable: false,
        stateMutability: "nonpayable",
        type: "function",
      },
      {
        constant: true,
        inputs: [],
        name: "totalSupply",
        outputs: [{ name: "", type: "uint256" }],
        payable: false,
        stateMutability: "view",
        type: "function",
      },
      {
        constant: false,
        inputs: [
          { name: "_from", type: "address" },
          { name: "_to", type: "address" },
          { name: "_value", type: "uint256" },
        ],
        name: "transferFrom",
        outputs: [{ name: "", type: "bool" }],
        payable: false,
        stateMutability: "nonpayable",
        type: "function",
      },
      {
        constant: true,
        inputs: [],
        name: "decimals",
        outputs: [{ name: "", type: "uint8" }],
        payable: false,
        stateMutability: "view",
        type: "function",
      },
      {
        constant: true,
        inputs: [{ name: "_owner", type: "address" }],
        name: "balanceOf",
        outputs: [{ name: "balance", type: "uint256" }],
        payable: false,
        stateMutability: "view",
        type: "function",
      },
      {
        constant: true,
        inputs: [],
        name: "symbol",
        outputs: [{ name: "", type: "string" }],
        payable: false,
        stateMutability: "view",
        type: "function",
      },
      {
        constant: false,
        inputs: [
          { name: "_to", type: "address" },
          { name: "_value", type: "uint256" },
        ],
        name: "transfer",
        outputs: [{ name: "", type: "bool" }],
        payable: false,
        stateMutability: "nonpayable",
        type: "function",
      },
      {
        constant: true,
        inputs: [
          { name: "_owner", type: "address" },
          { name: "_spender", type: "address" },
        ],
        name: "allowance",
        outputs: [{ name: "", type: "uint256" }],
        payable: false,
        stateMutability: "view",
        type: "function",
      },
      { payable: true, stateMutability: "payable", type: "fallback" },
      {
        anonymous: false,
        inputs: [
          { indexed: true, name: "owner", type: "address" },
          { indexed: true, name: "spender", type: "address" },
          { indexed: false, name: "value", type: "uint256" },
        ],
        name: "Approval",
        type: "event",
      },
      {
        anonymous: false,
        inputs: [
          { indexed: true, name: "from", type: "address" },
          { indexed: true, name: "to", type: "address" },
          { indexed: false, name: "value", type: "uint256" },
        ],
        name: "Transfer",
        type: "event",
      },

    ];
    async function main() {
      const web3 = new Web3("https://eth.llamarpc.com");
      let tokens = ['0xdac17f958d2ee523a2206206994597c13d831ec7', '0xB8c77482e45F1F44dE1745F52C74426C631bDD52', '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', '0xae7ab96520de3a18e5e111b5eaab095312d7fe84', '0x7d1afa7b718fb893db30a3abc0cfc608aacfebb0', '0x3883f5e181fccaf8410fa61e12b59bad963fb645', '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599', '0x95aD61b0a150d79219dCF64E1E6Cc01f0B64C4cE', '0x1f9840a85d5af5bf1d1762f925bdaddc4201f984', '0x6b175474e89094c44da98b954eedeac495271d0f', '0x4fabb145d64652a948d72533023f6e7a623c7c53', '0x2af5d2ad76741191d15dfe7bf6ac92d4bd912ca3', '0x514910771af9ca656af840dff83e8264ecf986ca', '0x0000000000085d4780B73119b644AE5ecd22b376', '0x75231f58b43240c9718dd58b4967c5114342a86c', '0x582d872a1b094fc48f5de31d3b73f2d9be47def1', '0x5a98fcbea516cf06857215779fd812ca3bef1b32', '0x2b591e99afe9f32eaa6214f7b7629768c40eeb39', '0xB50721BCf8d664c30412Cfbc6cf7a15145234ad1', '0xa0b73e1ff0b80914ab6fe0444e65848c4c34450b', '0xba3D9687Cf50fE253cd2e1cFeEdE1d6787344Ed5', '0xc944e90c64b2c07662a292be6244bdf05cda44a7', '0x85f17cf997934a597031b2e18a9ab6ebd4b9f6a4', '0xd850942ef8811f2a866692a623011bde52a462c1', '0x4a220e6096b25eadb88358cb44068a3248254675', '0x3845badAde8e6dFF049820680d1F14bD3903a5d0', '0x4d224452801aced8b2f0aebe155379bb5d594381', '0x1a4b46696b2bb4794eb3d4c26f1c55f9170fa4c5', '0x0f5d2fb29fb7d3cfee444a200298f468908cc942', '0x1a4b46696b2bb4794eb3d4c26f1c55f9170fa4c5', '0x0C10bF8FcB7Bf5412187A595ab97a3609160b5c6', '0xfd09cf7cfffa9932e33668311c4777cb9db3c9be', '0xe28b3B32B6c345A34Ff64674606124Dd5Aceca30', '0x6de037ef9ad2725eb40118bb1702ebb27e4aeb24', '0x6982508145454ce325ddbe47a25d4ec3d2311933', '0xf34960d9d60be18cc1d5afc1a6f012a723a28811', '0x056fd409e1d7a124bd7017459dfea2f387b6d5cd', '0x4ddc2d193948926d02f9b1fe9e1daa0718270ed5', '0x45804880De22913dAFE09f4980848ECE6EcbAf78', '0xc00e94cb662c3520282e6f5717214004a7f26888', '0xc669928185dbce49d2230cc9b0979be6dc797957', '0x6f259637dcd74c767781e37bc6133cd6a68aa161', '0x3432b6a60d23ca0dfca7761b7ab56459d9c964d0', '0x39aa39c021dfbae8fac545936693ac917d5e7563', '0xd7c49cee7e9188cca6ad8ff264c1da2e69d4cf3b', '0x111111111117dc0aa78b770fa6a738034120c302', '0xb62132e35a6c13ee1ee0f84dc5d40bad8d815206', '0x92d6c1e31e14520e676a687f0a93788b716beff5', '0x05f4a42e251f2d52b8ed15e9fedaacfcef1fad27', '0x152649eA73beAb28c5b49B26eb48f7EAD6d4c898', '0xf629cbd94d3791c9250152bd8dfbdf380e2a3b9c', '0x69af81e73a73b40adf4f3d4223cd9b1ece623074', '0x6c6ee5e31d828de241282b9606c8e98ea48526e2', '0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e', '0x0d8775f648430679a709e98d2b0cb6250d2887ef', '0x6810e776880c02933d47db1b9fc05908e5386b96'];
      // tokens = tokens.slice(0, 15)
      const totalCheck = tokens.length * tokens.length
      const USDollar = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
      })

      const TotalLostVolume = (props) => {
        return (
          <div>
            <h3>Total lost voluem USD</h3>
            <h2>{USDollar.format(props.totalLostVolume)}</h2>
          </div>
        );
      };

      const ProgressLostVolume = (props) => {
        const percent = props.totalPercentProcessed
        return (
          <div>
            <div className="progress">
              <div className="progress-bar bg-success" role="progressbar" style={{ width: `${percent}%` }} aria-valuenow={percent} aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        );
      };


      const Table = (props) => {
        const [totalLostVolume, setTotalLostVolume] = useState(0);
        const [totalPercentProcessed, setTotalPercentProcessed] = useState(0);

        const updateTotalLostVolume = (amount) => {
          setTotalLostVolume((prevTotal) => prevTotal + amount);
        };

        const updateTotalPercentProcessed = (percent) => {
          setTotalPercentProcessed((prevTotal) => prevTotal += percent);
        };

        return <div>
          <p>Your Table</p>
          <ProgressLostVolume totalPercentProcessed={totalPercentProcessed}/>
          <TotalLostVolume totalLostVolume={totalLostVolume} />
          <table className="table" id="table-tokens">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Logo</th>
                <th scope="col">Name</th>
                <th scope="col">Symbol</th>
                <th scope="col">Contract</th>
                <th scope="col">Price USD</th>
                <th scope="col">Lost volume</th>
                <th scope="col">Lost volume USD</th>
              </tr>
            </thead>
            <tbody>
              {props.data.map((x, i) => 
                <Row 
                  key={i}
                  data={x}
                  id={i} 
                  updateTotalLostVolume={updateTotalLostVolume} 
                  updateTotalPercentProcessed={updateTotalPercentProcessed}  
                />)}
            </tbody>
          </table>
        </div>
      }

      const Image = (props) => {
        const logo = props.data.logo && props.data.logo ? props.data.logo : "";
        if (logo == "") {
          
          return (
            <div className="spinner-border text-primary" style={{ width: "28px", height: "28px" }} role="status"></div>
            )
        } else {
          return <img src={logo.startsWith("ipfs://") ? logo.replace("ipfs://", "https://ipfs.io/ipfs/") : logo} style={{ width: "28px", height: "28px" }} loading="lazy" />
        }
      }

      const Row = (props) => {
        const [volume, setVolume] = useState(0);
        const [volumeUSD, setVolumeUSD] = useState(0);

        const [tokenDetail, setTokenDetail] = useState({});

        useEffect(() => {
          const fetchBalances = async () => {
            const token = new web3.eth.Contract(ERC20, props.data);
            let data = await getToken(props.data)
            if (!data) {

              data = {
                "name": "",
                "symbol": await token.methods.symbol().call(),
                "price": {"price": 0},
                "logo": ""
              }
            }
            setTokenDetail(data);
            const decimals = await token.methods.decimals().call();
            for (const element of tokens) {
              const getBalanceOf = async () => {
                return await token.methods.balanceOf(element).call().catch(async () => {
                  return await getBalanceOf();
                });
              };
              const balance = await getBalanceOf();
              
              // if (props.data == '0x514910771af9ca656af840dff83e8264ecf986ca') {
              //   console.log(balance, stuckAmount, await getBalanceOf()/ Number(`1e${decimals}`), '---', stuckAmount.length)
              // }
              const roundedAmount = balance / Number(`1e${decimals}`);
              setVolume((preVolume) => preVolume + roundedAmount);
              setVolumeUSD((preVolumeUSD) => preVolumeUSD + (roundedAmount * data.price.price))
              props.updateTotalPercentProcessed(100 * 1 / totalCheck);
              props.updateTotalLostVolume(roundedAmount * data.price.price);
            }
          }
          fetchBalances();
        }, []);
        
        if (tokenDetail) {
          return <tr>
            <td style={{ width: "5%" }}>{props.id}</td>
            <td style={{ width: "10%" }}> <Image data={tokenDetail}/></td>
            <td style={{ width: "10%" }}>{tokenDetail.name}</td>
            <td style={{ width: "5%" }}>{tokenDetail.symbol}</td>
            <td style={{ width: "26%" }}><a href={`https://etherscan.io/address/${props.data}`}>{props.data}</a></td>
            <td style={{width: "10%"}}>{tokenDetail.price ? tokenDetail.price.price || 0 : 0}</td>
            <td style={{width: "12%"}}>
              <span> {volume}</span>
            </td>
            <td style={{ width: "12%" }}><span>{USDollar.format(volumeUSD)}</span></td>
          </tr>
        }
      else {
        return <tr>
            <td>{props.id}</td>
            <td>#</td>
            <td>#</td>
            <td>#</td>
            <td><a href={`https://etherscan.io/address/${props.data}`}>{props.data}</a></td>
            <td></td>
            <td><span>{volume}</span>
            </td>
          </tr>
        };
      }

      async function fetchData(url) {
        return fetch(url)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json(); // Преобразуем полученные данные в формат JSON
          })
          .catch((error) => {
            console.error("Fetch error:", error);
          });
      }

      async function getToken(address) {
        const apiUrl = `https://api-data.absolutewallet.com/api/v1/contracts/tokens?network=eth&fiat=USD&search=${address}&page=1&size=1`
        const result = await fetchData(apiUrl)
        if (result.meta.total !== 0) {
            return Object.values(result.data)[0];
        } 
      }

      ReactDOM.render(<Table data={tokens}/>, document.getElementById("root"));
    }
    main()
  </script>
</body>

</html>